params {
    cluster = 'garrawarla'
    workDir = "/scratch/mwavcs/$USER/vcspipe_work"
    vcs_dir = "/scratch/mwavcs/$USER/vcs_downloads"
}

executor {
    $slurm {
        queueSize = 30  // Number of tasks handled in parallel
        submitRateLimit = '20/1min'  // Job submission rate
        pollInterval = 30.s  // How often to poll the job status
        jobName = { "${task.process}_(${task.index})" }
    }
    $local {
        // Local jobs should not be resource intensive
        cpus = 1
        memory = 8.GB
    }
}

process {
    cache = 'lenient'

    withLabel: cluster {
        executor = 'slurm'
    }

    withLabel: giantsquid {
        beforeScript = "export MWA_ASVO_API_KEY='${params.asvo_api_key}'; module load singularity/3.7.4; alias giant-squid='singularity exec /pawsey/mwa/singularity/giant-squid/giant-squid_latest.sif giant-squid'; alias jq=/home/cplee/bin/jq"
    }

    withName: VCSBEAM {
        queue = 'gpuq'
        time = { Integer.valueOf(params.vcsbeam_wt) * 1.h }
        maxForks = { Integer.valueOf(params.vcsbeam_forks) }
        clusterOptions = { "-A mwavcs --ntasks=${params.num_chan} --ntasks-per-node=1 --cpus-per-task=1 --mem-per-cpu=8G --gres=gpu:1" }
    }
}
